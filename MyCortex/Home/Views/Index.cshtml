<script>
    $(document).ready(function () {
        $(document).ready(function () {
            $('[data-toggle="tooltip"]').tooltip();
        });
        $('.dropdown-toggle:not(.noBind)').on('click', function () {
            $('.dropdown-toggle').removeClass('activeButton');
            $(this).addClass('activeButton');
        });
    });
</script>
<style>
.resizable .resizers .resizer{
  width: 5px;
  height: 5px;
  border-radius: 50%; /*magic to turn square into circle*/
  /*background: white;*/
  border: 3px solid #4286f4;
  position: absolute;
}

.resizers .resizer.top-left {
  left: -5px;
  top: -5px;
  cursor: nwse-resize; /*resizer cursor*/
}
</style>
@{
    ViewBag.Title = "Index";
    Layout = "~/Shared/Views/_Layout.cshtml";
}
<!DOCTYPE html>
<html ng-app="EmpApp">
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Index</title>
    
    <link href="@Url.Content("~/CSS/angular-ui.css")" rel="stylesheet" type="text/css"/> 
    <link href="@Url.Content("~/CSS/jquery.mCustomScrollbar.css")" rel="stylesheet" type="text/css"/>    
    <link href="@Url.Content("~/Css/bootstrap-multiselect.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Css/bootstrap-toggle.min.css")" rel="stylesheet" type="text/css" /> 
    <link href="@Url.Content("~/Css/chat.css")" rel="stylesheet" type="text/css" /> 
    
    <script src="@Url.Content("~/scripts/angular-ui.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/scripts/ui-bootstrap.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/scripts/ui-bootstrap-tpls.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/app/app.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/app/controller.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/pageSelect.directive.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/smart-table.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery.marquee.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery.mCustomScrollbar.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/scripts/moment.min.js")"></script>
    <script src="@Url.Content("~/scripts/Bootstrap-multiselect.js")"></script>    
    <script src="@Url.Content("~/scripts/bootstrap-toggle.min.js")"></script>
    <script src="@Url.Content("~/scripts/highcharts-ng.js")"></script>
    <script src="@Url.Content("~/scripts/highcharts.js")"></script>
    <script src="@Url.Content("~/scripts/highcharts-more.js")"></script>
    <script src="@Url.Content("~/scripts/highchart.solid-gauge.js")"></script>
    <script src="@Url.Content("~/Scripts/angular-sanitize.js")"></script>

    <script src="@Url.Content("~/scripts/jquery.playSound.js")"></script>
    <script src="@Url.Content("~/scripts/messaging/CometChat.js")"></script>
    <script src="@Url.Content("~/scripts/messaging/chatService.js")"></script>
    <script src="@Url.Content("~/scripts/Chatscripts.js")"></script>
    <script src="@Url.Content("~/Scripts/ckeditor/ckeditor.js")" type="text/javascript"></script>
</head>

<body class="" id="idbody">
    <div class="container">
        <div class="row">
            <div class="themeHeader">
            <div class="themeLogo">
                @*<img src="images/MyCortexLogo.JPG">*@
                <img src="images/MyCortexLogo.JPG" id="InstLogo">
            </div>
            <div class="themeLogo" id="divPatientType" style="display: none; margin-left: 20px;">
                <img src="images/Premium.svg" id="imgPatientType">
            </div>
            <div class="themeMenu">
                @{ var counter = 1; }
                @foreach (var menu in Model)
                {
                    if (counter ==1 && (@menu.Menu_Level == 1) && (@menu.HasChild == 0))
                    {
                        <div class="dropdown app_menu">
                            <button class="btn btn-primary dropdown-toggle activeButton" onclick="location.href = '@menu.Menu_URL'"
                                    type="button" aria-expanded="false">
                                @menu.Menu_Name
                            </button>
                        </div>
                    }
                    else if ((@menu.Menu_Level == 1) && (@menu.HasChild == 0))
                    {
                        <div class="dropdown app_menu">
                            <button class="btn btn-primary dropdown-toggle" onclick="location.href = '@menu.Menu_URL'"
                                    type="button" aria-expanded="false">
                                @menu.Menu_Name
                            </button>
                        </div>
                    }
                    else
                    {
                        if ((@menu.Menu_Level == 1) && (@menu.HasChild == 1))
                        {
                            <div class="dropdown app_menu">
                                <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown"
                                        aria-expanded="false">
                                    @menu.Menu_Name
                                    <span class="caret"></span>
                                </button>

                                <ul class="dropdown-menu customDropdown">
                                    @foreach (var submenu in Model)
                                    {
                                        if (@submenu.Parent_Id == @menu.Menu_Id)
                                        {
                                            <li class="customDropdownlast-child" onclick="location.href='@submenu.Menu_URL'" style="padding: 4px 16px !important;">@submenu.Menu_Name</li>
                                        }
                                    }
                                </ul>
                            </div>
                        }
                    }
                counter++;
                }
            </div>
            <div class="themeRight">
                <div id="mydiv" style="padding: 25px;">
                    <i class="fas fa-bell" id="UnreadCountIcon" data-placement="left"
                       data-toggle="tooltip" style="color:#FFF;font-size: 30px;" onclick="location.href = 'Home/Index#/NotificationView'"></i>
                </div>
                <span id="usernamespan">Admin</span>
                <div class="dropdown profile_menu">
                    <button class="btn btn-primary dropdown-toggle noBind" type="button" data-toggle="dropdown"
                        aria-expanded="false">
                        <img src="images/male.png"  id="profileIcon" class="themeProfile"
                            data-toggle="tooltip" data-placement="left">
                    </button>
                    <ul class="dropdown-menu customDropdown logoutDrop">
                        <li class="customDropdownlast-child" onclick="location.href = 'Home/Index#/ChangePassword/2'"
                            style="padding: 5px 20px !important;">Change Password</li>
                        <li class="customDropdownlast-child" onclick="location.href='@Url.Action("LoginOut", "Home" )'"
                            style="padding: 5px 20px !important;">
                            Log Out

                        </li>
                        <li class="customDropdownlast-child" onclick="location.href='@Url.Action("LoginOutAllDevice", "Home" )'"
                            style="padding: 5px 20px !important;">
                            Log Out From All Device

                        </li>
                    </ul>
                </div>
                
            </div>
        </div>

            <div class="col-md-12 bodyClick" id="DataToggle" ng-controller="ParentController">
                <div class="DataContainer" ng-view>
                    
                </div>
            </div>
        </div>
    </div>


    <a onclick="openChatWindow();" class="float ng-scope" id="btnopenchat" target="_blank" style="display:none">
        <i class="fa fa-comments my-float"></i>
    </a>
    <div class="chatBox chatBoxBig resizable" id="chatBox" style="display:none">
        <div class='resizers'>
            <div class='resizer top-left'></div>
            <div class='resizer top-right'></div>
            <div class='resizer bottom-left'></div>
            <div class='resizer bottom-right'></div>
        </div>
            <input id="loggedInUID" type="hidden" />
            <input id="chatUserUID" type="hidden" value="" />
            <input id="callSessionID" type="hidden" />

            <form id="message-form">
                <div class="chatHeader">
                    <span id="chatBoxOpener"><i class="fas fa-arrow-down"></i></span>
                    <img class="chatProfile" src="../../Images/male.png" alt="Profile">
                    <h1 id="h1user">
                        <br />
                        <span></span>
                    </h1>
                    <a class="callIcon" id="showchatIcon" onclick="showchatOnCall()">
                        <i class="far fa-comment-alt"></i>
                    </a>
                    @*<a href="#" class="callIcon" id="deleteGroup" title="Delete Group" style="display:none"><i class="fas fa-trash-alt"></i></a>*@
                    <a href="#" class="callIcon" id="addGroup" title="Create Group"><i class="fas fa-users"></i></a>
                    <a href="#" class="callIcon" id="addressBook" title="Show or hide contact book">
                        <i class="fas fa-address-book"></i>
                    </a>
                    <a class="callIcon" id="linkcallIcon" onclick="audioCallUser()">
                        <i class="fas fa-phone-alt"></i>
                    </a>
                    <a class="videoIcon" id="linkvideoIcon" onclick="videoCallUser()">
                        <i class="fas fa-video"></i>
                    </a>
                </div>
                <div class="chatBody contactList groupsList" id="groupsList" style="display: none;">
                    <div class="lds-ripple" id="groupcreateLoader" style="display: none;"><div></div><div></div></div>
                    <div class="searchHolder">
                        <input type="text" class="contactSearch" style="width: 75%;" id="groupname" placeholder="Group Name">
                        <button type="button" class="btn  btn-save ml-5" id="btnCreateGroup">
                            Create
                        </button>
                    </div>

                    <ul id="group-user" class="group-user">
                    </ul>

                </div>
                <div class="chatBody callBox" id="call-page" style="display:none">
                    <!--<p>Today</p>-->
                    <h2 id="callinitiatorname"><span></span></h2>
                    <a id="call-accept" class="call" onclick="callAccept()">
                        <i class="fa fa-phone-alt" aria-hidden="true"></i>
                    </a>
                    <a id="call-reject" class="call endCall" onclick="callReject()">
                        <img src="~/Images/callreject.jpg" style="height:40px;width:40px"/>
                    </a>
                </div>
                <div class="chatBody contactList chatBodyHalf" id="add-book">
                    <div class="searchHolder">
                        <input type="text" class="contactSearch" id="contactSearch" placeholder="Search Contact" onKeyup="searchContact_onKeyPress()">
                    </div>
                    @*<ul id="group-user">
                    </ul>*@
                    <div class="lds-ripple" id="chatLoader_add" style="display: none;"><div></div><div></div></div>
                    <ul id="address-user"></ul>
                </div>
                @*onscroll='alert("Scroll Called");'*@
                @*           <div class="chatBody" id="notificationList" style="display:none">
                    <ul class="notificationList">
                        <li>
                            <h1>Prasanth</h1>
                            <p>Yesterday,06.30 pm <i class="fas fa-phone-alt"></i></p>
                        </li>
                        <li>
                            <h1>Prasanth</h1>
                            <p>Yesterday,06.30 pm <i class="fas fa-video"></i></p>
                        </li>
                    </ul>
                </div>*@
                <div class="chatBody chatBodyHalf resizable" id="msg-page" style="display:block">
                    <div class="lds-ripple" id="chatLoader" style="display: none;"><div></div><div></div></div>
                    <ul id="group-message-holder"></ul>
                </div>
                <div class="chatFooter" id="msg-footer">
                    <input id='filechat' type='file' style="display:none" onchange="handleFiles(this.files)" />
                    <a class="chatAttachment" onclick="openChatAttachmentDialog()" id="btnfilechat"><i class="fas fa-paperclip"></i></a>
                    <input type="text" id="input-text" placeholder="Type your message..."
                           onKeyPress="sendChatonKeyPress(event)">
                    <a onclick="sendChatMessage()" ><i class="fas fa-chevron-circle-right"></i></a>
                </div>
            </form>
        </div>
</body>
</html>

<script type="text/javascript">
    (function ($) {
        /*$( "#chatBox" ).resizable({
            ghost: true,
            handles: "n, e, s, w",
            minHeight:430,
            stop:function(){
                let totalHeight = $('#chatBox').outerHeight() - 72;
                $('.chatBody').height(totalHeight);
                $('.group-user').height(totalHeight - 40)
               
            }
        });*/

        
        $('#deleteGroup').click(function (e) {
            e.preventDefault();
            chatService.deleteGroupDetails();
        });

        $('#addGroup').click(function (e) {
            e.preventDefault();

            if ($("#addressBook").hasClass("aqua") == true) {

                $('.chatBody').toggleClass('chatBodyHalf');
                $('.contactList').toggle();
                $('#groupsList').hide();
                $('#addressBook').toggleClass('aqua');
                $('.chatBox').toggleClass('chatBoxBig')
            }

            if ($("#addGroup").hasClass("aqua") == false) {
                $('.chatBody').hide();
                $('#groupsList').show();
                $('.chatBox').removeClass('chatBoxBig')
                $('#addGroup').toggleClass('aqua');

                chatService.groupaddressbookDetails();
            }
            else
            {
                $('.chatBody').show();
                $('#groupsList').hide();
                $('.chatBox').addClass('chatBoxBig')
                $('#addGroup').toggleClass('aqua');
                $('#call-page').hide();
                chatService.getaddressbookDetails($('#contactSearch').val());
            }
        })
        $(window).on("load", function () {
        
            $('#chatBox').attr("style", "display:none");
            $('#btnopenchat').hide();
            $("#showchatIcon").hide();
            if (window.localStorage['UserTypeId'] != "1" && window.localStorage['UserTypeId'] != "3") {
                utilService.initializeChat();
            }           

            // create group option for Care Giver and Care Coordinator
            if (window.localStorage['UserTypeId'] != "5" && window.localStorage['UserTypeId'] != "6") {
                $('#addGroup').hide();  
            }
        });

    })(jQuery);

    $('#addressBook').click(function (e) {
        e.preventDefault()

        if ($("#addGroup").hasClass("aqua") == true) {
            $('.chatBody').show();
            $('#groupsList').hide();
            $('.chatBox').addClass('chatBoxBig')
            $('#addGroup').toggleClass('aqua');
            $('#call-page').hide();
        }
        $('.chatBody').toggleClass('chatBodyHalf');
        $('.contactList').toggle();
        $('#groupsList').hide();
        $('#addressBook').toggleClass('aqua');
        //$("#call-page").attr("style", "display:none");
        //if ($("#showchatIcon").css('display') == "none") {
        //    $("#call-page").attr("style", "display:none")
        //    $("#msg-page").attr("style", "display:block")
        //}            
        //else {
        //    if ($("#showchatIcon").hasClass("aqua") == false) {
        //        $("#call-page").attr("style", "display:none")
        //        $("#msg-page").attr("style", "display:block")
        //    }
        //    else {
        //        $("#call-page").attr("style", "display:flex")
        //        $("#msg-page").attr("style", "display:none")
        //    }
        //}
        
        //else {
        //    $("#call-page").attr("style", "display:flex")
        //    $("#msg-page").attr("style", "display:none")
        //}

        $('.chatBox').toggleClass('chatBoxBig')
        chatService.scrollToBottom();
    })

    $('#btnCreateGroup').click(function (e) {
        e.preventDefault()
        if ($("#groupname").val() == "")
        {
            alert("Please enter Group name");
            return false;
        }
        $("#groupcreateLoader").attr("style", "display:block")
        chatService.createGroup($("#groupname").val());
        $("#groupcreateLoader").attr("style", "display:none")
    })
    
    function openChatWindow() {
        if (window.localStorage['UserTypeId'] != "1" && window.localStorage['UserTypeId'] != "3") {
            chatService.openChatfromOtherPage();
        }
        else {
            $('#chatBox').attr("style", "display:none");
            $('#btnopenchat').attr("style", "display:none");
        }
    }

    function searchContact_onKeyPress() {
        //$('#address-user > li:not(:contains(' + $('#contactSearch').val() + '))').hide();
        //$('#address-user > li:contains(' + $('#contactSearch').val() + ')').show();
        chatService.getaddressbookDetails($('#contactSearch').val());

        /*var listItems = $("#address-user li");
        listItems.each(function (idx, li) {
            var product = $(li);
            console.log(product[0].innerHTML.toLowerCase().contains($('#contactSearch').val().toLowerCase()));
            // and the rest of your code
        });*/

    }
    $('#chatBoxOpener').click(function () {
        $('.chatBox').toggleClass('chatBoxClose');
        if ($('#chatBox').hasClass('chatBoxClose') == true) {

            $('#chatBox').attr('style', 'height:430px;width:630px;bottom: -430px !important;');
            //$('#chatBox').attr('style', 'height:430px;width:630px;bottom: -' + $('#chatBox').outerHeight(true) + 'px !important;');
        }
        else
        {
            $('#chatBox').attr('style', 'display: block;height:430px;width:630px');
        }

        let totalHeight = $('#chatBox').outerHeight() - 72;
        $('.chatBody').height(totalHeight);
        $('.group-user').height(totalHeight - 72)

        $('#address-user').height(totalHeight - 40);

        $(this).find('i').toggleClass('fa-arrow-up');
        $(this).find('i').toggleClass('fa-arrow-down');
    })
    // chat window
    function chatarrowclick() {
        $('.chatBox').toggleClass('chatBoxClose');
        $('#chatBoxOpener').find('i').toggleClass('fa-arrow-up');
        $('#chatBoxOpener').find('i').toggleClass('fa-arrow-down');
    }
    function openChatAttachmentDialog() {
        document.getElementById('filechat').click();
    }
    function handleFiles() {
        chatService.sendMediaMessage();
        //chatService.getaddressbookDetails($('#contactSearch').val());
    }
    function sendChatonKeyPress(evt) {
        var charCode = (evt.which) ? evt.which : event.keyCode;
        if (charCode == 13) {
            sendChatMessage()
            //chatService.getaddressbookDetails($('#contactSearch').val());
        }
        else {
            if (evt.target.value === "")
                chatService.endTypeingNot();
            else
                chatService.startTypeingNot();
        }
    }
    function sendChatMessage() {
        //chatService.createGroup();
        chatService.sendMessage();
        //chatService.getaddressbookDetails($('#contactSearch').val());
    }
    function audioCallUser() {
        if ($("#addressBook").hasClass("aqua") == true) {
            $('.chatBody').toggleClass('chatBodyHalf');
            $('.contactList').toggle();
            $('#groupsList').hide();
            $('#addressBook').toggleClass('aqua');
            $('.chatBox').toggleClass('chatBoxBig');
        }

        chatService.initiateCall();
    }
    function videoCallUser() {
        chatService.initiateVideCall();
    }
    function openUserChat(userType, viewUser, userValidity)
    {

        chatService.fetchMessages(userType, viewUser.toString());
        if (userValidity == "false") {
            $('#linkcallIcon').hide();
            $('#linkvideoIcon').hide();
            $('#input-text').prop('disabled', true);
            $("#btnfilechat").attr("style", "display:none")
        }
        else {
            $('#linkcallIcon').show();
            $('#linkvideoIcon').show();
            $('#input-text').prop('disabled', false);
            $("#btnfilechat").attr("style", "display:block")
        }
    }
    
    function callAccept() {
        chatService.callAccept();
    }
    function callReject() {
        chatService.callReject();
    }
    function showchatOnCall()
    {
        $('.contactList').toggle();
        $('#groupsList').hide();
        $('#addressBook').hide();
        if ($("#showchatIcon").hasClass("aqua") == false) {
            $("#call-page").attr("style", "display:none")
            $('#showchatIcon').toggleClass('aqua');
            $("#msg-page").attr("style", "display:block");
        }
        else
        {
            $("#call-page").attr("style", "display:flex")
            $('#showchatIcon').toggleClass('aqua');
            $("#msg-page").attr("style", "display:none")
        }
        
    }

    function makeResizableDiv(div) {
        // default size = 680 * 430
        const element = document.querySelector(div);
        const resizers = document.querySelectorAll(div + ' .resizer')
        const minimum_size = 20;
        let original_width = 0;
        let original_height = 0;
        let original_x = 0;
        let original_y = 0;
        let original_mouse_x = 0;
        let original_mouse_y = 0;
        for (let i = 0;i < resizers.length; i++) {
            const currentResizer = resizers[i];
            currentResizer.addEventListener('mousedown', function(e) {
                e.preventDefault()
                original_width = parseFloat(getComputedStyle(element, null).getPropertyValue('width').replace('px', ''));
                original_height = parseFloat(getComputedStyle(element, null).getPropertyValue('height').replace('px', ''));
                original_x = element.getBoundingClientRect().left;
                original_y = element.getBoundingClientRect().top;
                original_mouse_x = e.pageX;
                original_mouse_y = e.pageY;
                window.addEventListener('mousemove', resize)
                window.addEventListener('mouseup', stopResize)
            })
    
            function resize(e) {
                // restrict when minimizing the chat window 
                if (e.pageX > original_mouse_x && original_width - (e.pageX - original_mouse_x) < 680)
                    return false;
                if (e.pageY > original_mouse_y && original_height - (e.pageY - original_mouse_y) < 430)
                    return false;

                // restrict when maximizing the chat window
                if (e.pageX < original_mouse_x && original_width - (e.pageX - original_mouse_x) > 1000)
                    return false;
                if (e.pageY < original_mouse_y && original_height - (e.pageY - original_mouse_y) > 550)
                    return false;

                if (currentResizer.classList.contains('bottom-right')) {
                    const width = original_width + (e.pageX - original_mouse_x);
                    const height = original_height + (e.pageY - original_mouse_y)
                    if (width > minimum_size) {
                        element.style.width = width + 'px'
                    }
                    if (height > minimum_size) {
                        element.style.height = height + 'px'
                    }
                }
                else if (currentResizer.classList.contains('bottom-left')) {
                    const height = original_height + (e.pageY - original_mouse_y)
                    const width = original_width - (e.pageX - original_mouse_x)
                    if (height > minimum_size) {
                        element.style.height = height + 'px'
                    }
                    if (width > minimum_size) {
                        element.style.width = width + 'px'
                        element.style.left = original_x + (e.pageX - original_mouse_x) + 'px'
                    }
                }
                else if (currentResizer.classList.contains('top-right')) {
                    const width = original_width + (e.pageX - original_mouse_x)
                    const height = original_height - (e.pageY - original_mouse_y)
                    if (width > minimum_size) {
                        element.style.width = width + 'px'
                    }
                    if (height > minimum_size) {
                        element.style.height = height + 'px'
                        element.style.top = original_y + (e.pageY - original_mouse_y) + 'px'
                    }
                }
                else {
                    const width = original_width - (e.pageX - original_mouse_x)
                    const height = original_height - (e.pageY - original_mouse_y)
                    if (width > minimum_size) {
                        element.style.width = width + 'px'
                        element.style.left = original_x + (e.pageX - original_mouse_x) + 'px'
                    }
                    if (height > minimum_size) {
                        element.style.height = height + 'px'
                        element.style.top = original_y + (e.pageY - original_mouse_y) + 'px'
                    }
                }
                let totalHeight = $('#chatBox').outerHeight() - 72;
                $('.chatBody').height(totalHeight);
                $('.group-user').height(totalHeight - 72)

                $('#address-user').height(totalHeight - 40);

            }
    
            function stopResize() {
                window.removeEventListener('mousemove', resize)
            }
        }
    }

    makeResizableDiv('.resizable')
</script>
<link rel="manifest" href="manifest.json" />

<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-messaging.js"></script>

<script src="firebase-messaging-sw.js"></script>
<script src="@Url.Content("~/scripts/messaging/notification.js")"></script>